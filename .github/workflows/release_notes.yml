name: Release

on:
 workflow_dispatch:

jobs:
  fetch-latest-release-notes:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: View latest release and store release notes
      run: |
        latest_tag=$(gh release list --limit 1 | awk '{print $1}')
        echo $latest_tag
        gh release view $latest_tag --json body | jq -r .body > release_notes.md
      env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  

    - name: Print Release Notes
      run: cat release_notes.md

    - name: Install Pandoc
      run: |
        sudo apt-get update
        sudo apt-get install -y pandoc

    - name: Convert MD to Confluence Markup
      run: |
        pandoc -s release_notes.md -o confluence_markup.txt
        echo test
        cat confluence_markup.txt
    - name: Publish to Confluence
      env:
        LOGIN: jatsingh9696@gmail.com
        PASSWORD: ATATT3xFfGF0X7DrLhE-8H46tLQtsUMPo1SuTWp4fBnymhCeP6qCs6ukxOAxM9T6GRJ49fu5VOJkS2y_PSnErk1Y0ATnUHQF-3R0N8XkmXpfloE72XvYKSoqQ0zCIT0-Cne3CYMOCLKI5JrQzhKihcyKfqzVVFVRMxRl4WI4yVdZedaBcNBv048=51EE7C43
        CONFLUENCE_URL: https://jatin-bamel.atlassian.net/wiki/rest/api/
        CONFLUENCE_SPACE: testj3
        CONFLUENCE_PARENT_PAGE_ID: 950287
      run: |
        curl -u "${LOGIN}:${PASSWORD}" -X PUT -H 'Content-Type: application/json' \
          -d '{"version":{"number":your_current_page_version},"title":"Your Page Title","type":"page","body":{"storage":{"value":"$(< confluence_markup.txt)","representation":"storage"}}}' \
          "${CONFLUENCE_URL}content/${CONFLUENCE_PARENT_PAGE_ID}/child/${CONFLUENCE_SPACE}"




